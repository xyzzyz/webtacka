<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript" src="webgl-utils.js"> </script>
<script type="text/javascript">

    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }

var gl;
var positionLocation;
var colorLocation;
var lastTick;
var i=0;
var leftTurn=false;
var rightTurn = false;

function init() {
	canvas = document.getElementById("lesson01-canvas");
        gl = canvas.getContext("experimental-webgl");
        gl.viewportWidth = canvas.width;
        gl.viewportHeight = canvas.height;


	var fragmentShader = getShader(gl, "2d-fragment-shader");
        var vertexShader = getShader(gl, "2d-vertex-shader");

        var program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);
	gl.useProgram(program);

	gl.positionLocation = gl.getAttribLocation(program, "a_position");
        gl.colorLocation = gl.getAttribLocation(program, "a_color");
	gl.enable(gl.LINE_SMOOTH);
	gl.lineWidth(3);

        gl.viewport(0.0, 0.0, canvas.width, canvas.height);
	gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.disable(gl.DEPTH_TEST);
	d = new Date();
	lastTick = d.getTime();
}


function drawTrace(trace, color) {
	var n = trace.length;
	var vertices = new Array(2*n);
	var colors = new Array(4*n);
	for(var i=0; i<n-5; ++i) 
	{
		vertices[2*i] = trace[i].x;
		vertices[2*i+1] = trace[i].y;
		colors[4*i]   = color.r;
		colors[4*i+1] = color.g;
		colors[4*i+2] = color.b;
		colors[4*i+3] = color.a;
	}
	buffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
	buffer.itemSize = 2;
	buffer.numItems = n;
	gl.vertexAttribPointer(gl.positionLocation, 2, gl.FLOAT, false, 0, 0);
	gl.enableVertexAttribArray(gl.positionLocation);

	
	colorBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
	buffer.itemSize = 4;
	buffer.numItems = n;
	gl.vertexAttribPointer(gl.colorLocation, 4, gl.FLOAT, false, 0, 0);
	gl.enableVertexAttribArray(gl.colorLocation);
	gl.drawArrays(gl.LINE_STRIP, 0, n);
}

function tick() {
	d = new Date();
	ntime = d.getTime();
	time = (ntime - lastTick)/1000;
	lastTick = ntime;

	requestAnimFrame(tick);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	for(var i = 0; i< players.length; ++i) {
		players[i].step();
		drawTrace(players[i].trace, players[i].color);
	}
}

function color(r,g,b,a)
{
	this.r=r;
	this.g=g;
	this.b=b;
	this.a=a;
}

function point(x,y)
{
	this.x=x;
	this.y=y;
};

function player() {
	this.trace = new Array(200);
	for(var i=-100; i<100; ++i)
	{
		this.trace[i+100] = new point(i/100, Math.sin(4*i/100));
	}
	this.color = new color(1,0,0,1);
	this.position = new point(Math.random()*2-1, Math.random()*2-1);
	this.direction = Math.random()*Math.PI*2;
}
var dt = 0.3;
var dphi = 0.3;

player.prototype.step = function() {
	if(leftTurn) {
		this.direction += time*Math.PI*dphi;
	}
	if(rightTurn) {
		this.direction -= time*Math.PI*dphi;
	}
	this.position.x += time*Math.sin(this.direction)*dt;
	this.position.y += time*Math.cos(this.direction)*dt;
	this.trace.push(new point(this.position.x, this.position.y));
}

function WebGLStart() {
	players = [ new player() ];
	init();
	tick();
}
</script>
<script id="2d-vertex-shader" type="x-shader/x-vertex">
attribute vec2 a_position;
attribute vec4 a_color;
varying vec4 v_color;

void main() {
  gl_Position = vec4(a_position, 0, 1);
  v_color = a_color;
}
</script>

<script id="2d-fragment-shader" type="x-shader/x-fragment">
precision mediump float;
varying vec4 v_color;
void main() {
  gl_FragColor = v_color;
}
</script>
</head>
<body onload="WebGLStart()">
<canvas id="lesson01-canvas" style="border: none;" width="500" height="500"></canvas>
</body>
</html>
