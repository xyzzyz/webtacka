<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript" src="webgl-utils.js"> </script>
<script type="text/javascript" src="jquery-1.7.2.js"> </script>
<script type="text/javascript">


    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }

var gl;
var positionLocation;
var colorLocation;
var lastTick;
var i=0;
var leftTurn=false;
var rightTurn = false;

function init() {
 	$('body').keydown(function(event) {
		if(event.which == 37) {
			leftTurn = true;
		} else if(event.which == 39) {
			rightTurn = true;
		}
	});
 	$('body').keyup(function(event) {
		if(event.which == 37) {
			leftTurn = false;
		} else if(event.which == 39) {
			rightTurn = false;
		}
	});

	canvas = document.getElementById("lesson01-canvas");
        gl = canvas.getContext("experimental-webgl");
        gl.viewportWidth = canvas.width;
        gl.viewportHeight = canvas.height;


	var fragmentShader = getShader(gl, "2d-fragment-shader");
        var vertexShader = getShader(gl, "2d-vertex-shader");

        var program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);
	gl.useProgram(program);

	gl.positionLocation = gl.getAttribLocation(program, "a_position");
        gl.colorLocation = gl.getAttribLocation(program, "a_color");
	gl.enable(gl.LINE_SMOOTH);
	gl.lineWidth(3);

        gl.viewport(0.0, 0.0, canvas.width, canvas.height);
	gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.disable(gl.DEPTH_TEST);
	d = new Date();
	lastTick = d.getTime();
}

function hsv(h, s, v)
{
   this.hue = h;
   this.sat = s;
   this.val = v;
}

var hsv2rgb = function(hsv) {
  var h = hsv.hue, s = hsv.sat, v = hsv.val;
  var rgb, i, data = [];
  if (s === 0) {
    rgb = [v,v,v];
  } else {
    h = h / 60;
    i = Math.floor(h);
    data = [v*(1-s), v*(1-s*(h-i)), v*(1-s*(1-(h-i)))];
    switch(i) {
      case 0:
        rgb = [v, data[2], data[0]];
        break;
      case 1:
        rgb = [data[1], v, data[0]];
        break;
      case 2:
        rgb = [data[0], v, data[2]];
        break;
      case 3:
        rgb = [data[0], data[1], v];
        break;
      case 4:
        rgb = [data[2], data[0], v];
        break;
      default:
        rgb = [v, data[0], data[1]];
        break;
    }
  }
  return rgb;
};

function pointFromServer(nick, point, direction) 
{
	players[nick].addPoint(point, direction);
};

function drawTrace(plr) {
	var n = plr.server_trace.length + plr.temp_trace.length;
	var vertices = new Array(2*n);
	var colors = new Array(4*n);
	//var col = rgb(hsv2rgb(new hsv(180, 1, 1)));
	//var col = new color(0, 1, 0, 1);
	var i=0;
	for(i=0; i<plr.server_trace.length; ++i) 
	{
		vertices[2*i] = plr.server_trace[i].x;
		vertices[2*i+1] = plr.server_trace[i].y;
		col = rgb(hsv2rgb(new hsv(i % 360, 1, 1)));
		colors[4*i]   = col.r;
		colors[4*i+1] = col.g;
		colors[4*i+2] = col.b;
		colors[4*i+3] = col.a;
	}

	for(; i<n; ++i)
	{
		j = i - plr.server_trace.length;
		vertices[2*i] = plr.temp_trace[j];
		vertices[2*i+1] = plr.temp_trace[j];
		col = rgb(hsv2rgb(new hsv(i % 360, 1, 1)));
		colors[4*i]   = col.r;
		colors[4*i+1] = col.g;
		colors[4*i+2] = col.b;
		colors[4*i+3] = col.a;
	}
	buffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
	buffer.itemSize = 2;
	buffer.numItems = n;
	gl.vertexAttribPointer(gl.positionLocation, 2, gl.FLOAT, false, 0, 0);
	gl.enableVertexAttribArray(gl.positionLocation);

	
	colorBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
	buffer.itemSize = 4;
	buffer.numItems = n;
	gl.vertexAttribPointer(gl.colorLocation, 4, gl.FLOAT, false, 0, 0);
	gl.enableVertexAttribArray(gl.colorLocation);
	gl.drawArrays(gl.LINE_STRIP, 0, n);
}

function tick() {
	d = new Date();
	ntime = d.getTime();
	time = (ntime - lastTick)/1000;
	lastTick = ntime;

	requestAnimFrame(tick);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	for(var i = 0; i< players.length; ++i) {
		players[i].step();
		drawTrace(players[i]);
	}
}

function rgb(arr) 
{
	return new color(arr[0], arr[1], arr[2], 1);
}

function color(r,g,b,a)
{
	this.r=r;
	this.g=g;
	this.b=b;
	this.a=a;
}

function point(x,y)
{
	this.x=x;
	this.y=y;
};

function player() {
	this.color = new color(0,1,0,1);
	this.position = new point(Math.random()*2-1, Math.random()*2-1);
	this.direction = Math.random()*Math.PI*2;
	this.server_trace = [ new point(this.position.x, this.position.y)];
	this.temp_trace = [];
}
var dt = 0.3;
var dphi = 0.6;

player.prototype.step = function() {
	if(leftTurn) {
		this.direction -= time*Math.PI*dphi;
	}
	if(rightTurn) {
		this.direction += time*Math.PI*dphi;
	}
	this.position.x += time*Math.sin(this.direction)*dt;
	this.position.y += time*Math.cos(this.direction)*dt;
	this.temp_trace.push(new point(this.position.x, this.position.y));
}

player.prototype.addPoint = function(pnt, direction)
{
	this.position = pnt;
	this.direction = direction;
	this.server_trace.push(pnt);
	this.temp_trace.length = 0;
}

function WebGLStart() {
	players = [ new player() ];
	init();
	tick();
}
</script>
<script id="2d-vertex-shader" type="x-shader/x-vertex">
attribute vec2 a_position;
attribute vec4 a_color;
varying vec4 v_color;

void main() {
  gl_Position = vec4(a_position, 0, 1);
  v_color = a_color;
}
</script>

<script id="2d-fragment-shader" type="x-shader/x-fragment">
precision mediump float;
varying vec4 v_color;
void main() {
  gl_FragColor = v_color;
}
</script>
</head>
<body onload="WebGLStart()">
<canvas id="lesson01-canvas" style="border: none;" width="500" height="500"></canvas>
</body>
</html>
